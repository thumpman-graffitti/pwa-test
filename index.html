<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="PG Live Log" />
  <title>PG Live Log</title>
  <style>
    body { font-family: sans-serif; padding: 20px; line-height: 1.6; max-width: 800px; margin: auto; }
    input, select, button { display: block; width: 100%; margin-bottom: 10px; padding: 12px; box-sizing: border-box; border-radius: 5px; border: 1px solid #ccc; font-size: 16px; }
    button { cursor: pointer; background: #007bff; color: white; border: none; font-weight: bold; }
    button:hover { background: #0056b3; }
    .secondary-btn { background: #6c757d; }
    .tertiary-btn { background: #28a745; }
    li { margin-bottom: 10px; border-bottom: 1px dotted #ccc; padding-bottom: 8px; list-style: none; }
    .stats-container { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px; }
    .live-card { border-left: 5px solid #007bff; background: #fff; padding: 10px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .loading { text-align: center; color: #666; margin-top: 50px; }
    .encore { color: #dc3545; font-weight: bold; margin-left: 5px; }
    .rank-num { font-weight: bold; color: #555; width: 35px; display: inline-block; }
    .last-played { display: block; font-size: 0.8em; color: #888; margin-left: 35px; }
    .song-title { color: #007bff; text-decoration: underline; cursor: pointer; font-weight: bold; }
    .album-name { font-size: 0.8em; color: #666; margin-left: 5px; }
  </style>
</head>
<body>

<h1>ğŸµ PG DB9</h1>

<div id="loader" class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>

<div id="app-ui" style="display:none;">
  <label>ãƒ©ã‚¤ãƒ–å±¥æ­´ã‚’è¡¨ç¤ºï¼š</label>
  <select id="liveSelect">
    <option value="">-- ãƒ©ã‚¤ãƒ–ã‚’é¸æŠ --</option>
  </select>

  <button onclick="showGlobalStats()" class="secondary-btn">ğŸ“Š å…¨æ¼”å¥æ›²ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤º</button>
  <button onclick="showUnplayedSongs()" class="tertiary-btn">ğŸ”• æœªæ¼”å¥ã®æ›²ä¸€è¦§ã‚’è¡¨ç¤º</button>
ã€€<button onclick="showPrefStats()" class="secondary-btn">ğŸ—¾ éƒ½é“åºœçœŒåˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤º</button>

  <div id="displayArea" class="stats-container">
    <p>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰æ“ä½œã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
  </div>
</div>

<script>
  let lives = [];
  let setlists = [];
  let songsMaster = [];

  async function init() {
    try {
      const [resLives, resSets, resSongs] = await Promise.all([
        fetch('lives.json'),
        fetch('setlists.json'),
        fetch('songs_master.json')
      ]);

      lives = await resLives.json();
      setlists = await resSets.json();
      songsMaster = await resSongs.json();

      renderLiveSelect();
      document.getElementById('loader').style.display = 'none';
      document.getElementById('app-ui').style.display = 'block';
    } catch (error) {
      document.getElementById('loader').innerHTML = `<p style="color:red;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>`;
      console.error(error);
    }
  }

  function renderLiveSelect() {
    const select = document.getElementById('liveSelect');
    const sortedLives = [...lives].sort((a, b) => new Date(b.date) - new Date(a.date));
    sortedLives.forEach(live => {
      const opt = document.createElement('option');
      opt.value = live.id;
      opt.textContent = `${live.date} ${live.title}`;
      select.appendChild(opt);
    });
    select.addEventListener('change', (e) => { if (e.target.value) showSetlist(e.target.value); });
  }

  function showSetlist(liveId) {
    const live = lives.find(l => l.id === liveId);
    const filteredSet = setlists.filter(s => s.live_id === liveId).sort((a, b) => a.order - b.order);
    const area = document.getElementById('displayArea');
    let html = `<h2>${live.title}</h2><p>ğŸ“… ${live.date} ğŸ“ ${live.venue}</p><hr><ul>`;
    filteredSet.forEach(item => {
      html += `<li>${item.order}. <strong>${item.song_title}</strong>${item.is_encore ? '<span class="encore">(Encore)</span>' : ''}</li>`;
    });
    area.innerHTML = html + `</ul>`;
  }

// å…¨æ¼”å¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆè¶…å¼·åŠ›ãŠæƒé™¤ç‰ˆï¼‰
  function showGlobalStats() {
    const counts = {};
    const lastLiveMap = {};

    setlists.forEach(s => {
      counts[s.song_id] = (counts[s.song_id] || 0) + 1;
      const currentLive = lives.find(l => l.id === s.live_id);
      if (currentLive) {
        if (!lastLiveMap[s.song_id] || new Date(currentLive.date) > new Date(lastLiveMap[s.song_id].date)) {
          lastLiveMap[s.song_id] = currentLive;
        }
      }
    });

    const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
    const area = document.getElementById('displayArea');
    let html = `<h2>ğŸ“Š å…¨æ¼”å¥æ›²ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2><ul>`;
    
    let rank = 1;
    sorted.forEach(([songId, count], index) => {
      if (index > 0 && count < sorted[index - 1][1]) rank = index + 1;
      
      const song = songsMaster.find(sm => String(sm.id).padStart(3, '0') === String(songId).padStart(3, '0'));

      // --- è¶…å¼·åŠ›ãŠæƒé™¤ãƒ­ã‚¸ãƒƒã‚¯ ---
      let rawTitle = song ? song.title : (setlists.find(s => s.song_id === songId)?.song_title || `ID:${songId}`);
      
      let title = rawTitle
        .replace(/^"/g, "")        // å…ˆé ­ã® " ã‚’å‰Šé™¤
        .split('(')[0]             // ( ãŒã‚ã‚Œã°ã€ãã‚Œã‚ˆã‚Šå‰ã ã‘ã‚’å–ã‚Šå‡ºã™
        .split('ï¼ˆ')[0]            // å…¨è§’ã® ï¼ˆ ã‚‚åŒæ§˜
        .trim();                   // å‰å¾Œã®ç©ºç™½ã‚’å‰Šé™¤
      // --------------------------

      const lastLive = lastLiveMap[songId];
      
      html += `<li>
                <span class="rank-num">${rank}ä½</span>
                <span class="song-title" onclick="showSongHistory('${songId}', '${title.replace(/'/g, "\\'")}')">${title}</span> (${count}å›)
                ${lastLive ? `<span class="last-played">${lastLive.date} ã€Œ${lastLive.title}ã€</span>` : ''}
              </li>`;
    });
    area.innerHTML = html + `</ul>`;
  }

  // æœªæ¼”å¥ã®æ›²ä¸€è¦§ï¼ˆè¶…å¼·åŠ›ãŠæƒé™¤ç‰ˆï¼‰
  function showUnplayedSongs() {
    const playedSongIds = new Set(setlists.map(s => String(s.song_id).padStart(3, '0')));
    
    const unplayed = songsMaster
      .filter(sm => !playedSongIds.has(String(sm.id).padStart(3, '0')))
      .sort((a, b) => (a.title || "").localeCompare(b.title || "", 'ja'));

    const area = document.getElementById('displayArea');
    let html = `<h2>ğŸ”• æœªæ¼”å¥ã®æ›²ä¸€è¦§ (${unplayed.length}æ›²)</h2><ul>`;
    
    if (unplayed.length === 0) {
      html += `<p>ã™ã¹ã¦ã®æ›²ãŒæ¼”å¥æ¸ˆã¿ã§ã™ï¼</p>`;
    } else {
      unplayed.forEach(song => {
        // --- è¶…å¼·åŠ›ãŠæƒé™¤ãƒ­ã‚¸ãƒƒã‚¯ ---
        let title = (song.title || "åç§°ä¸æ˜")
          .replace(/^"/g, "")
          .split('(')[0]
          .split('ï¼ˆ')[0]
          .trim();
        
        // songs_master.jsonã«åˆã‚ã›ã¦å°æ–‡å­—ã® .album ã‚’å‚ç…§
        const albumName = song.album || 'ã‚¢ãƒ«ãƒãƒ ä¸æ˜';
        html += `<li>ãƒ»${title} <span class="album-name">(${albumName})</span></li>`;
      });
    }
    area.innerHTML = html + `</ul>`;
  }

 
    function showSongHistory(songId, songTitle) {
    const history = setlists.filter(s => String(s.song_id).padStart(3, '0') === String(songId).padStart(3, '0'));
    const area = document.getElementById('displayArea');
    let html = `<h3>ğŸ¸ ã€Œ${songTitle}ã€ã®æ¼”å¥å±¥æ­´</h3>`;
    html += `<button onclick="showGlobalStats()" class="secondary-btn" style="width:auto; padding:5px 15px;">â† ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«æˆ»ã‚‹</button><br><br>`;
    
    history.sort((a,b) => {
      const liveA = lives.find(l => l.id === a.live_id);
      const liveB = lives.find(l => l.id === b.live_id);
      return new Date(liveB.date) - new Date(liveA.date);
    }).forEach(h => {
      const live = lives.find(l => l.id === h.live_id);
      if (live) {
        html += `<div class="live-card"><b>ğŸ“… ${live.date}</b><br>ğŸ¤ ${live.title}<br><small>ğŸ“ ${live.venue}</small></div>`;
      }
    });
    area.innerHTML = html;
  }

  // 3. éƒ½é“åºœçœŒãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
  function showPrefStats() {
    const counts = {};

    lives.forEach(live => {
      const pref = live.prefecture || "ä¸æ˜";
      counts[pref] = (counts[pref] || 0) + 1;
    });

    const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
    const area = document.getElementById('displayArea');
    
    let html = `<h2>ğŸ—¾ éƒ½é“åºœçœŒåˆ¥ é–‹å‚¬ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2><ul>`;
    
    let rank = 1;
    sorted.forEach(([pref, count], index) => {
      if (index > 0 && count < sorted[index - 1][1]) rank = index + 1;
      
      html += `
        <li onclick="showPrefHistory('${pref}')" style="cursor:pointer; color:#007bff; text-decoration:underline;">
          <span class="rank-num">${rank}ä½</span>
          <strong>${pref}</strong> (${count}å›)
        </li>`;
    });
    
    area.innerHTML = html + `</ul>`;
  }

  // éƒ½é“åºœçœŒã”ã¨ã®é–‹å‚¬å±¥æ­´è¡¨ç¤º
  function showPrefHistory(prefName) {
    const history = lives.filter(l => l.prefecture === prefName)
                         .sort((a, b) => new Date(b.date) - new Date(a.date));
    
    const area = document.getElementById('displayArea');
    let html = `<h3>ğŸ“ ${prefName} ã§ã®é–‹å‚¬å±¥æ­´</h3>`;
    html += `<button onclick="showPrefStats()" class="secondary-btn" style="width:auto; padding:5px 15px;">â† ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«æˆ»ã‚‹</button><br><br>`;
    
    history.forEach(live => {
      html += `
        <div class="live-card">
          <b>ğŸ“… ${live.date}</b><br>
          ğŸ¤ ${live.title}<br>
          <small>ğŸ“ ${live.venue}</small>
        </div>`;
    });
    area.innerHTML = html;
  }

  // æ—¢å­˜ã® showSetlist ã‚‚IDæ¯”è¼ƒã‚’å®‰å…¨ã«ä¿®æ­£
  function showSetlist(liveId) {
    // 4æ¡ã«æƒãˆã¦æ¯”è¼ƒ
    const targetLiveId = String(liveId).padStart(4, '0');
    const live = lives.find(l => String(l.id).padStart(4, '0') === targetLiveId);
    const filteredSet = setlists.filter(s => String(s.live_id).padStart(4, '0') === targetLiveId).sort((a, b) => a.order - b.order);
    
    const area = document.getElementById('displayArea');
    let html = `<h2>${live.title}</h2><p>ğŸ“… ${live.date} ğŸ“ ${live.venue}</p><hr><ul>`;
    filteredSet.forEach(item => {
      html += `<li>${item.order}. <strong>${item.song_title}</strong>${item.is_encore ? '<span class="encore">(Encore)</span>' : ''}</li>`;
    });
    area.innerHTML = html + `</ul>`;
  }


  init();
</script>
</body>
</html>





