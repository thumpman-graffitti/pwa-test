<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="PG Live Log" />
  <title>PG Live Log</title>
  <style>
    body { font-family: sans-serif; padding: 20px; line-height: 1.6; }
    input, select, button { display: block; width: 100%; margin-bottom: 10px; padding: 10px; box-sizing: border-box; }
    button { cursor: pointer; background: #f0f0f0; border: 1px solid #ccc; }
    .delete-btn { background: #ffcccc; border: 1px solid #ff0000; width: auto; display: inline; padding: 2px 8px; margin-left: 10px; }
    li { margin-bottom: 10px; border-bottom: 1px dotted #ccc; padding-bottom: 5px; }
  </style>
</head>
<body>

<h1>ğŸµ PG ãƒ©ã‚¤ãƒ–å±¥æ­´ï¼•</h1>

<label>ãƒ©ã‚¤ãƒ–ã‚’é¸æŠï¼š</label>
<select id="masterSelect">
  <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
</select>

<input id="memo" type="text" placeholder="åº§å¸­ãƒ»ãƒ¡ãƒ¢ï¼ˆä¾‹ï¼šã‚¢ãƒªãƒ¼ãƒŠA5ï¼‰" />
<button onclick="saveLive()" style="background: #e1f5fe;">âœ¨ å‚åŠ ç™»éŒ²</button>

<hr>

<button onclick="exportData()">ğŸ“¤ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆå…±æœ‰ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ï¼‰</button>
<input type="file" id="importFile" accept=".json" onchange="importData()" />
<button onclick="testClear()" style="color: red;">ğŸ§ª å…¨å‰Šé™¤ãƒ†ã‚¹ãƒˆ</button>

<hr>
<h2>ğŸ“Š å…¨ãƒ©ã‚¤ãƒ–çµ±è¨ˆ</h2>
<button onclick="showGlobalStats()" style="background: #fff9c4;">å…¨ãƒ©ã‚¤ãƒ–ã®æ¼”å¥å›æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’é›†è¨ˆ</button>
<div id="statsArea" style="background: #f9f9f9; padding: 10px; border-radius: 5px; margin-bottom: 20px; max-height: 300px; overflow-y: auto;">
  ã“ã“ã«ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
</div>
<hr>
  
<h2>å‚åŠ å±¥æ­´</h2>
<ul id="list"></ul>

<script>
  let db;

  // DBåˆæœŸåŒ–
  const request = indexedDB.open("pgLiveDB", 1);
  request.onupgradeneeded = (event) => {
    db = event.target.result;
    if (!db.objectStoreNames.contains("lives")) {
      db.createObjectStore("lives", { keyPath: "id", autoIncrement: true });
    }
  };
  request.onsuccess = (event) => {
    db = event.target.result;
    render();
    loadMasterData(); // DBæº–å‚™å®Œäº†å¾Œã«ãƒã‚¹ã‚¿ãƒ¼èª­ã¿è¾¼ã¿
  };

  // 1. ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«å…¥ã‚Œã‚‹
  function loadMasterData() {
    // â˜…ã“ã“ã‚’è‡ªåˆ†ã®GitHub URLã«æ›¸ãæ›ãˆã¦ãã ã•ã„ï¼
    const masterUrl = "https://thumpman-graffitti.github.io/pwa-test/live_master.json";

    fetch(masterUrl)
      .then(res => res.json())
      .then(data => {
        const select = document.getElementById("masterSelect");
        select.innerHTML = '<option value="">ãƒ©ã‚¤ãƒ–ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
        data.forEach(live => {
          const option = document.createElement("option");
          option.value = JSON.stringify(live);
          option.textContent = `${live.date} - ${live.tour}`;
          select.appendChild(option);
        });
      })
      .catch(err => {
        console.error(err);
        document.getElementById("masterSelect").innerHTML = '<option value="">ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—</option>';
      });
  }

  // 2. ä¿å­˜å‡¦ç†ï¼ˆ1ã¤ã«çµ±åˆï¼‰
  function saveLive() {
    const selectedValue = document.getElementById("masterSelect").value;
    const memo = document.getElementById("memo").value;

    if (!selectedValue) {
      alert("ãƒ©ã‚¤ãƒ–ã‚’é¸æŠã—ã¦ãã ã•ã„");
      return;
    }

    const liveData = JSON.parse(selectedValue);
    const tx = db.transaction("lives", "readwrite");
    const store = tx.objectStore("lives");

    store.add({ 
      date: liveData.date, 
      venue: liveData.venue,
      tour: liveData.tour,
      memo: memo 
    });

    tx.oncomplete = () => {
      document.getElementById("memo").value = "";
      render();
    };
  }

  // 3. è¡¨ç¤ºå‡¦ç†
  function render() {
    const list = document.getElementById("list");
    list.innerHTML = "";

    const tx = db.transaction("lives", "readonly");
    const store = tx.objectStore("lives");

    store.openCursor().onsuccess = (event) => {
      const cursor = event.target.result;
      if (cursor) {
        const li = document.createElement("li");
        const d = cursor.value;
        
        // è¡¨ç¤ºå†…å®¹ã‚’ãƒªãƒƒãƒã«
        li.innerHTML = `
          <strong>${d.date} ${d.tour}</strong><br>
          <small>ä¼šå ´: ${d.venue} ${d.memo ? ' / ãƒ¡ãƒ¢: ' + d.memo : ''}</small>
        `;

        const delBtn = document.createElement("button");
        delBtn.textContent = "å‰Šé™¤";
        delBtn.className = "delete-btn";
        const currentId = cursor.primaryKey;
        delBtn.onclick = () => deleteLive(currentId);

        li.appendChild(delBtn);
        list.appendChild(li);
        cursor.continue();
      }
    };
  }

  // å‰Šé™¤å‡¦ç†
  function deleteLive(id) {
    if (!confirm("ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    const tx = db.transaction("lives", "readwrite");
    tx.objectStore("lives").delete(id);
    tx.oncomplete = () => render();
  }

  // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆBOMä»˜ãUTF-8ï¼‰
  function exportData() {
    const tx = db.transaction("lives", "readonly");
    tx.objectStore("lives").getAll().onsuccess = (e) => {
      const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
      const blob = new Blob([bom, JSON.stringify(e.target.result, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "pg_live_log.json";
      a.click();
    };
  }

  // ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
  function importData() {
    const file = document.getElementById("importFile").files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      const json = JSON.parse(e.target.result);
      const tx = db.transaction("lives", "readwrite");
      const store = tx.objectStore("lives");
      json.forEach(item => { delete item.id; store.add(item); });
      tx.oncomplete = () => { alert("å¾©å…ƒå®Œäº†"); render(); };
    };
    reader.readAsText(file);
  }

  // å…¨å‰Šé™¤
  function testClear() {
    if (!confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    const tx = db.transaction("lives", "readwrite");
    tx.objectStore("lives").clear();
    tx.oncomplete = () => render();
  }

// å…¨ãƒ©ã‚¤ãƒ–çµ±è¨ˆï¼ˆãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’ä½¿ç”¨ï¼‰ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
function showGlobalStats() {
  const masterUrl = "https://thumpman-graffitti.github.io/pwa-test/live_master.json";
  const songsUrl = "https://thumpman-graffitti.github.io/pwa-test/songs_master.json";

  const statsArea = document.getElementById("statsArea");
  statsArea.innerHTML = "é›†è¨ˆä¸­...";

  Promise.all([
    fetch(masterUrl).then(res => res.json()),
    fetch(songsUrl).then(res => res.json())
  ]).then(([lives, songs]) => {
    
    // é›†è¨ˆç”¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ‹¡å¼µ
    // { "001": { count: 5, lastDate: "2024-09-08", lastLive: "è§£æ”¾åŒº" } }
    let songStats = {}; 

    // 1. å…¨ãƒ©ã‚¤ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆï¼ˆå¤ã„é †ã«å‡¦ç†ã—ã¦æœ€æ–°ã§ä¸Šæ›¸ãã™ã‚‹ãŸã‚ï¼‰
    lives.sort((a, b) => new Date(a.date) - new Date(b.date));

    // 2. å…¨ãƒ©ã‚¤ãƒ–ã®ã‚»ãƒˆãƒªã‚’ã‚¹ã‚­ãƒ£ãƒ³
    lives.forEach(live => {
      if (live.setlist && Array.isArray(live.setlist)) {
        live.setlist.forEach(songId => {
          if (!songStats[songId]) {
            songStats[songId] = { count: 0, lastDate: "", lastLive: "" };
          }
          songStats[songId].count += 1;
          // å¤ã„é †ã«ãƒ«ãƒ¼ãƒ—ã—ã¦ã„ã‚‹ã®ã§ã€å¸¸ã«å¾Œã®æ—¥ä»˜ï¼ˆæœ€æ–°ï¼‰ã®æƒ…å ±ã§æ›´æ–°ã•ã‚Œã‚‹
          songStats[songId].lastDate = live.date;
          songStats[songId].lastLive = live.tour;
        });
      }
    });

    // 3. é›†è¨ˆçµæœã‚’æ›²æƒ…å ±ã¨ç´ä»˜ã‘
    let stats = songs.map(song => {
      const s = songStats[song.id] || { count: 0, lastDate: "-", lastLive: "-" };
      return {
        title: song.title,
        count: s.count,
        lastDate: s.lastDate,
        lastLive: s.lastLive,
        type: song.type === 's' ? 'ğŸ’¿' : 'ğŸ¸'
      };
    });

    // 4. æ¼”å¥å›æ•°é †ã«ä¸¦ã³æ›¿ãˆ
    stats.sort((a, b) => b.count - a.count);

    // 5. ãƒ†ãƒ¼ãƒ–ãƒ«æç”»ï¼ˆåˆ—ã‚’å¢—ã‚„ã—ã¾ã—ãŸï¼‰
    let html = "<table style='width:100%; text-align:left; border-collapse:collapse; font-size: 0.9em;'>";
    html += "<tr style='border-bottom:2px solid #ccc; background:#eee;'>";
    html += "<th>é †ä½</th><th>æ›²å</th><th>å›æ•°</th><th>ç›´è¿‘æ¼”å¥æ—¥</th><th>æœ€æ–°ãƒ©ã‚¤ãƒ–å</th></tr>";
    
// 5. è¡¨ç¤ºã‚¨ãƒªã‚¢ã®æç”»ï¼ˆ2æ®µãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰
    let html = "";
    
    stats.forEach((s, index) => {
      if (s.count > 0) {
        // å„æ›²ã‚’1ã¤ã®ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆã‚«ãƒ¼ãƒ‰ï¼‰ã¨ã—ã¦ä½œæˆ
        html += `
          <div style="border-bottom: 1px solid #ddd; padding: 10px 5px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
              <div style="font-weight: bold; font-size: 1.1em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                <span style="color: #888; margin-right: 5px;">${index + 1}.</span>
                ${s.type} ${s.title}
              </div>
              <div style="background: #e60012; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.9em; flex-shrink: 0;">
                ${s.count}å›
              </div>
            </div>
            
            <div style="font-size: 0.85em; color: #666; display: flex; flex-wrap: wrap; gap: 8px;">
              <span>ğŸ“… ${s.lastDate}</span>
              <span>ğŸ¤ ${s.lastLive}</span>
            </div>
          </div>
        `;
      }
    });
    
    if (html === "") html = "æ¼”å¥å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚";
    statsArea.innerHTML = html;
    
    html += "</table>";
    
    statsArea.innerHTML = html;

  }).catch(err => {
    console.error(err);
    statsArea.innerHTML = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
  });
}


</script>

</body>
</html>




