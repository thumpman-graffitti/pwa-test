<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="PG Live Log" />
  <title>PG Live Log</title>
  <style>
    body { font-family: sans-serif; padding: 20px; line-height: 1.6; max-width: 800px; margin: auto; }
    input, select, button { display: block; width: 100%; margin-bottom: 10px; padding: 12px; box-sizing: border-box; border-radius: 5px; border: 1px solid #ccc; font-size: 16px; }
    button { cursor: pointer; background: #007bff; color: white; border: none; font-weight: bold; }
    button:hover { background: #0056b3; }
    .secondary-btn { background: #6c757d; }
    .tertiary-btn { background: #28a745; }
    li { margin-bottom: 10px; border-bottom: 1px dotted #ccc; padding-bottom: 8px; list-style: none; }
    .stats-container { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px; }
    .live-card { border-left: 5px solid #007bff; background: #fff; padding: 10px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .loading { text-align: center; color: #666; margin-top: 50px; }
    .encore { color: #dc3545; font-weight: bold; margin-left: 5px; }
    .rank-num { font-weight: bold; color: #555; width: 35px; display: inline-block; }
    .last-played { display: block; font-size: 0.8em; color: #888; margin-left: 35px; }
    .song-title { color: #007bff; text-decoration: underline; cursor: pointer; font-weight: bold; }
    .album-name { font-size: 0.8em; color: #666; margin-left: 5px; }
    label { font-size: 0.9em; color: #555; font-weight: bold; display: block; margin-bottom: 5px; }
  </style>
</head>
<body>

<h1>ğŸµ PGDB</h1>

<div id="loader" class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>

<div id="app-ui" style="display:none;">
  <label>1. ãƒ„ã‚¢ãƒ¼ãƒ»ãƒ©ã‚¤ãƒ–åã‚’é¸æŠï¼š</label>
  <select id="tourSelect">
    <option value="">-- ãƒ„ã‚¢ãƒ¼ã‚’é¸æŠ --</option>
  </select>

  <label>2. å…¬æ¼”æ—¥ã‚’é¸æŠï¼š</label>
  <select id="liveSelect" disabled>
    <option value="">-- å…ˆã«ãƒ„ã‚¢ãƒ¼ã‚’é¸æŠ --</option>
  </select>

  <button onclick="showGlobalStats()" class="secondary-btn">ğŸ“Š å…¨æ¼”å¥æ›²ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤º</button>
  <button onclick="showUnplayedSongs()" class="tertiary-btn">ğŸ”• æœªæ¼”å¥ã®æ›²ä¸€è¦§ã‚’è¡¨ç¤º</button>
ã€€<button onclick="showPrefStats()" class="secondary-btn">ğŸ—¾ éƒ½é“åºœçœŒåˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤º</button>

  <div id="displayArea" class="stats-container">
    <p>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰æ“ä½œã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
  </div>
</div>

<script>
  let lives = [];
  let setlists = [];
  let songsMaster = [];

  async function init() {
    try {
      const fetchJson = async (file) => {
        const res = await fetch(file);
        if (!res.ok) throw new Error(`${file} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
        return await res.json();
      };

      const [resLives, resSets, resSongs] = await Promise.all([
        fetchJson('lives.json'),
        fetchJson('setlists.json'),
        fetchJson('songs_master.json')
      ]);

      lives = resLives;
      setlists = resSets;
      songsMaster = resSongs;

      renderTourSelect();
      document.getElementById('loader').style.display = 'none';
      document.getElementById('app-ui').style.display = 'block';
    } catch (error) {
      console.error("Load Error:", error);
      document.getElementById('loader').innerHTML = `<p style="color:red;">èª­ã¿è¾¼ã¿å¤±æ•—: ${error.message}</p>`;
    }
  }

  // ãƒ„ã‚¢ãƒ¼é¸æŠè‚¢ã‚’ç”Ÿæˆï¼ˆæ—¥ä»˜ã®é™é †ï¼‰
  function renderTourSelect() {
    const tourSelect = document.getElementById('tourSelect');
    
    // ãƒ„ã‚¢ãƒ¼ã”ã¨ã«æœ€æ–°ã®æ—¥ä»˜ã‚’è¨˜éŒ²
    const tourMap = new Map();
    lives.forEach(live => {
      if (!tourMap.has(live.title) || new Date(live.date) > new Date(tourMap.get(live.title))) {
        tourMap.set(live.title, live.date);
      }
    });

    // æœ€æ–°æ—¥ä»˜ãŒæ–°ã—ã„é †ã«ãƒ„ã‚¢ãƒ¼ã‚¿ã‚¤ãƒˆãƒ«ã‚’ã‚½ãƒ¼ãƒˆ
    const sortedTours = Array.from(tourMap.keys()).sort((a, b) => {
      return new Date(tourMap.get(b)) - new Date(tourMap.get(a));
    });

    sortedTours.forEach(title => {
      const opt = document.createElement('option');
      opt.value = title;
      opt.textContent = title;
      tourSelect.appendChild(opt);
    });

    // ãƒ„ã‚¢ãƒ¼ãŒé¸ã°ã‚ŒãŸã‚‰å…¬æ¼”æ—¥ãƒªã‚¹ãƒˆã‚’æ›´æ–°
    tourSelect.addEventListener('change', (e) => {
      renderLiveSelect(e.target.value);
    });
  }

  // å…¬æ¼”æ—¥é¸æŠè‚¢ã‚’ç”Ÿæˆï¼ˆæ—¥ä»˜ã®é™é †ï¼‰
  function renderLiveSelect(selectedTitle) {
    const liveSelect = document.getElementById('liveSelect');
    liveSelect.innerHTML = '<option value="">-- å…¬æ¼”æ—¥ã‚’é¸æŠ --</option>';
    
    if (!selectedTitle) {
      liveSelect.disabled = true;
      return;
    }

    const filteredLives = lives
      .filter(l => l.title === selectedTitle)
      .sort((a, b) => new Date(b.date) - new Date(a.date));

    filteredLives.forEach(live => {
      const opt = document.createElement('option');
      opt.value = live.id;
      opt.textContent = `${live.date} ã€${live.venue}ã€‘`;
      liveSelect.appendChild(opt);
    });

    liveSelect.disabled = false;
    liveSelect.onchange = (e) => { if (e.target.value) showSetlist(e.target.value); };
  }

  function showSetlist(liveId) {
    const targetLiveId = String(liveId).padStart(4, '0');
    const live = lives.find(l => String(l.id).padStart(4, '0') === targetLiveId);
    const filteredSet = setlists.filter(s => String(s.live_id).padStart(4, '0') === targetLiveId).sort((a, b) => a.order - b.order);
    
    const area = document.getElementById('displayArea');
    let html = `<h2>${live.title}</h2><p>ğŸ“… ${live.date} ğŸ“ ${live.venue}</p><hr><ul>`;
    if (filteredSet.length === 0) html += `<p>ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>`;
    filteredSet.forEach(item => {
      html += `<li>${item.order}. <strong>${item.song_title}</strong>${item.is_encore ? '<span class="encore">(Encore)</span>' : ''}</li>`;
    });
    area.innerHTML = html + `</ul>`;
  }

  // å…¨æ¼”å¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°
  function showGlobalStats() {
    const counts = {};
    const lastLiveMap = {};

    setlists.forEach(s => {
      counts[s.song_id] = (counts[s.song_id] || 0) + 1;
      const currentLive = lives.find(l => String(l.id).padStart(4, '0') === String(s.live_id).padStart(4, '0'));
      if (currentLive) {
        if (!lastLiveMap[s.song_id] || new Date(currentLive.date) > new Date(lastLiveMap[s.song_id].date)) {
          lastLiveMap[s.song_id] = currentLive;
        }
      }
    });

    const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
    const area = document.getElementById('displayArea');
    let html = `<h2>ğŸ“Š å…¨æ¼”å¥æ›²ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2><ul>`;
    
    let rank = 1;
    sorted.forEach(([songId, count], index) => {
      if (index > 0 && count < sorted[index - 1][1]) rank = index + 1;
      const song = songsMaster.find(sm => String(sm.id).padStart(3, '0') === String(songId).padStart(3, '0'));
      let title = song ? song.title : (setlists.find(s => s.song_id === songId)?.song_title || `ID:${songId}`);
      title = title.replace(/^"/g, "").split('(')[0].split('ï¼ˆ')[0].trim();

      const lastLive = lastLiveMap[songId];
      html += `<li>
                <span class="rank-num">${rank}ä½</span>
                <span class="song-title" onclick="showSongHistory('${songId}', '${title.replace(/'/g, "\\'")}')">${title}</span> (${count}å›)
                ${lastLive ? `<span class="last-played">æœ€çµ‚æ¼”å¥: ${lastLive.date} ã€Œ${lastLive.title}ã€</span>` : ''}
              </li>`;
    });
    area.innerHTML = html + `</ul>`;
  }

  // æœªæ¼”å¥æ›²ä¸€è¦§
  function showUnplayedSongs() {
    const playedSongIds = new Set(setlists.map(s => String(s.song_id).padStart(3, '0')));
    const unplayed = songsMaster
      .filter(sm => !playedSongIds.has(String(sm.id).padStart(3, '0')))
      .sort((a, b) => (a.title || "").localeCompare(b.title || "", 'ja'));

    const area = document.getElementById('displayArea');
    let html = `<h2>ğŸ”• æœªæ¼”å¥ã®æ›²ä¸€è¦§ (${unplayed.length}æ›²)</h2><ul>`;
    if (unplayed.length === 0) {
      html += `<p>ã™ã¹ã¦ã®æ›²ãŒæ¼”å¥æ¸ˆã¿ã§ã™ï¼</p>`;
    } else {
      unplayed.forEach(song => {
        let title = (song.title || "åç§°ä¸æ˜").replace(/^"/g, "").split('(')[0].split('ï¼ˆ')[0].trim();
        html += `<li>ãƒ»${title} <span class="album-name">(${song.album || 'ä¸æ˜'})</span></li>`;
      });
    }
    area.innerHTML = html + `</ul>`;
  }

  // æ¥½æ›²æ¼”å¥å±¥æ­´
  function showSongHistory(songId, songTitle) {
    const history = setlists.filter(s => String(s.song_id).padStart(3, '0') === String(songId).padStart(3, '0'));
    const area = document.getElementById('displayArea');
    let html = `<h3>ğŸ¸ ã€Œ${songTitle}ã€ã®æ¼”å¥å±¥æ­´</h3>`;
    html += `<button onclick="showGlobalStats()" class="secondary-btn" style="width:auto; padding:5px 15px;">â† ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«æˆ»ã‚‹</button><br><br>`;
    
    history.sort((a,b) => {
      const liveA = lives.find(l => String(l.id).padStart(4, '0') === String(a.live_id).padStart(4, '0'));
      const liveB = lives.find(l => String(l.id).padStart(4, '0') === String(b.live_id).padStart(4, '0'));
      return new Date(liveB.date) - new Date(liveA.date);
    }).forEach(h => {
      const live = lives.find(l => String(l.id).padStart(4, '0') === String(h.live_id).padStart(4, '0'));
      if (live) {
        html += `<div class="live-card"><b>ğŸ“… ${live.date}</b><br>ğŸ¤ ${live.title}<br><small>ğŸ“ ${live.venue}</small></div>`;
      }
    });
    area.innerHTML = html;
  }

  // éƒ½é“åºœçœŒåˆ¥
  function showPrefStats() {
    const counts = {};
    lives.forEach(live => {
      const pref = live.prefecture || "ä¸æ˜";
      counts[pref] = (counts[pref] || 0) + 1;
    });
    const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
    const area = document.getElementById('displayArea');
    let html = `<h2>ğŸ—¾ éƒ½é“åºœçœŒåˆ¥ é–‹å‚¬ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2><ul>`;
    let rank = 1;
    sorted.forEach(([pref, count], index) => {
      if (index > 0 && count < sorted[index - 1][1]) rank = index + 1;
      html += `<li onclick="showPrefHistory('${pref}')" style="cursor:pointer; color:#007bff; text-decoration:underline;">
                <span class="rank-num">${rank}ä½</span><strong>${pref}</strong> (${count}å›)</li>`;
    });
    area.innerHTML = html + `</ul>`;
  }

  function showPrefHistory(prefName) {
    const history = lives.filter(l => l.prefecture === prefName).sort((a, b) => new Date(b.date) - new Date(a.date));
    const area = document.getElementById('displayArea');
    let html = `<h3>ğŸ“ ${prefName} ã§ã®é–‹å‚¬å±¥æ­´</h3>`;
    html += `<button onclick="showPrefStats()" class="secondary-btn" style="width:auto; padding:5px 15px;">â† ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«æˆ»ã‚‹</button><br><br>`;
    history.forEach(live => {
      html += `<div class="live-card"><b>ğŸ“… ${live.date}</b><br>ğŸ¤ ${live.title}<br><small>ğŸ“ ${live.venue}</small></div>`;
    });
    area.innerHTML = html;
  }

  init();
</script>
</body>
</html>
