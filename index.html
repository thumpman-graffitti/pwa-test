<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="PG Live Log" />
  <title>PG Live Log</title>
  <style>
    body { font-family: sans-serif; padding: 20px; line-height: 1.6; }
    input, select, button { display: block; width: 100%; margin-bottom: 10px; padding: 10px; box-sizing: border-box; }
    button { cursor: pointer; background: #f0f0f0; border: 1px solid #ccc; }
    .delete-btn { background: #ffcccc; border: 1px solid #ff0000; width: auto; display: inline; padding: 2px 8px; margin-left: 10px; }
    li { margin-bottom: 10px; border-bottom: 1px dotted #ccc; padding-bottom: 5px; }
  </style>
</head>
<body>

<h1>ğŸµ PG ãƒ©ã‚¤ãƒ–å±¥æ­´</h1>

<label>ãƒ©ã‚¤ãƒ–ã‚’é¸æŠï¼š</label>
<select id="masterSelect">
  <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
</select>

<input id="memo" type="text" placeholder="åº§å¸­ãƒ»ãƒ¡ãƒ¢ï¼ˆä¾‹ï¼šã‚¢ãƒªãƒ¼ãƒŠA5ï¼‰" />
<button onclick="saveLive()" style="background: #e1f5fe;">âœ¨ å‚åŠ ç™»éŒ²</button>

<hr>

<button onclick="exportData()">ğŸ“¤ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆå…±æœ‰ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ï¼‰</button>
<input type="file" id="importFile" accept=".json" onchange="importData()" />
<button onclick="testClear()" style="color: red;">ğŸ§ª å…¨å‰Šé™¤ãƒ†ã‚¹ãƒˆ</button>

<hr>
<h2>ğŸ“Š å…¨ãƒ©ã‚¤ãƒ–çµ±è¨ˆ</h2>
<button onclick="showGlobalStats()" style="background: #fff9c4;">å…¨ãƒ©ã‚¤ãƒ–ã®æ¼”å¥å›æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’é›†è¨ˆ</button>

<button onclick="showUnplayedSongs()" style="background: #e1f5fe; margin-top: 5px;">ğŸš« æœªæ¼”å¥æ›²ï¼ˆãƒ¬ã‚¢æ›²ï¼‰ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º</button>
  
  <div id="statsArea" style="background: #f9f9f9; padding: 10px; border-radius: 5px; margin-bottom: 20px; max-height: 300px; overflow-y: auto;">
  ã“ã“ã«ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
</div>
<hr>


  
<h2>å‚åŠ å±¥æ­´</h2>
<ul id="list"></ul>

<script>
  let db;

  // DBåˆæœŸåŒ–
  const request = indexedDB.open("pgLiveDB", 1);
  request.onupgradeneeded = (event) => {
    db = event.target.result;
    if (!db.objectStoreNames.contains("lives")) {
      db.createObjectStore("lives", { keyPath: "id", autoIncrement: true });
    }
  };
  request.onsuccess = (event) => {
    db = event.target.result;
    render();
    loadMasterData(); // DBæº–å‚™å®Œäº†å¾Œã«ãƒã‚¹ã‚¿ãƒ¼èª­ã¿è¾¼ã¿
  };

  // 1. ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«å…¥ã‚Œã‚‹
  function loadMasterData() {
    // â˜…ã“ã“ã‚’è‡ªåˆ†ã®GitHub URLã«æ›¸ãæ›ãˆã¦ãã ã•ã„ï¼
    const masterUrl = "https://thumpman-graffitti.github.io/pwa-test/live_master.json";

    fetch(masterUrl)
      .then(res => res.json())
      .then(data => {
        const select = document.getElementById("masterSelect");
        select.innerHTML = '<option value="">ãƒ©ã‚¤ãƒ–ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
        data.forEach(live => {
          const option = document.createElement("option");
          option.value = JSON.stringify(live);
          option.textContent = `${live.date} - ${live.tour}`;
          select.appendChild(option);
        });
      })
      .catch(err => {
        console.error(err);
        document.getElementById("masterSelect").innerHTML = '<option value="">ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—</option>';
      });
  }

  // 2. ä¿å­˜å‡¦ç†ï¼ˆ1ã¤ã«çµ±åˆï¼‰
  function saveLive() {
    const selectedValue = document.getElementById("masterSelect").value;
    const memo = document.getElementById("memo").value;

    if (!selectedValue) {
      alert("ãƒ©ã‚¤ãƒ–ã‚’é¸æŠã—ã¦ãã ã•ã„");
      return;
    }

    const liveData = JSON.parse(selectedValue);
    const tx = db.transaction("lives", "readwrite");
    const store = tx.objectStore("lives");

    store.add({ 
      date: liveData.date, 
      venue: liveData.venue,
      tour: liveData.tour,
      memo: memo 
    });

    tx.oncomplete = () => {
      document.getElementById("memo").value = "";
      render();
    };
  }

  // 3. è¡¨ç¤ºå‡¦ç†
  function render() {
    const list = document.getElementById("list");
    list.innerHTML = "";

    const tx = db.transaction("lives", "readonly");
    const store = tx.objectStore("lives");

    store.openCursor().onsuccess = (event) => {
      const cursor = event.target.result;
      if (cursor) {
        const li = document.createElement("li");
        const d = cursor.value;
        
        // è¡¨ç¤ºå†…å®¹ã‚’ãƒªãƒƒãƒã«
        li.innerHTML = `
          <strong>${d.date} ${d.tour}</strong><br>
          <small>ä¼šå ´: ${d.venue} ${d.memo ? ' / ãƒ¡ãƒ¢: ' + d.memo : ''}</small>
        `;

        const delBtn = document.createElement("button");
        delBtn.textContent = "å‰Šé™¤";
        delBtn.className = "delete-btn";
        const currentId = cursor.primaryKey;
        delBtn.onclick = () => deleteLive(currentId);

        li.appendChild(delBtn);
        list.appendChild(li);
        cursor.continue();
      }
    };
  }

  // å‰Šé™¤å‡¦ç†
  function deleteLive(id) {
    if (!confirm("ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    const tx = db.transaction("lives", "readwrite");
    tx.objectStore("lives").delete(id);
    tx.oncomplete = () => render();
  }

  // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆBOMä»˜ãUTF-8ï¼‰
  function exportData() {
    const tx = db.transaction("lives", "readonly");
    tx.objectStore("lives").getAll().onsuccess = (e) => {
      const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
      const blob = new Blob([bom, JSON.stringify(e.target.result, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "pg_live_log.json";
      a.click();
    };
  }

  // ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
  function importData() {
    const file = document.getElementById("importFile").files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      const json = JSON.parse(e.target.result);
      const tx = db.transaction("lives", "readwrite");
      const store = tx.objectStore("lives");
      json.forEach(item => { delete item.id; store.add(item); });
      tx.oncomplete = () => { alert("å¾©å…ƒå®Œäº†"); render(); };
    };
    reader.readAsText(file);
  }

  // å…¨å‰Šé™¤
  function testClear() {
    if (!confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    const tx = db.transaction("lives", "readwrite");
    tx.objectStore("lives").clear();
    tx.oncomplete = () => render();
  }

// å…¨ãƒ©ã‚¤ãƒ–çµ±è¨ˆï¼ˆãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’ä½¿ç”¨ï¼‰ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
function showGlobalStats() {
  const masterUrl = "https://thumpman-graffitti.github.io/pwa-test/live_master.json";
  const songsUrl = "https://thumpman-graffitti.github.io/pwa-test/songs_master.json";

  const statsArea = document.getElementById("statsArea");
  statsArea.innerHTML = "é›†è¨ˆä¸­...";

  Promise.all([
    fetch(masterUrl).then(res => res.json()),
    fetch(songsUrl).then(res => res.json())
  ]).then(([lives, songs]) => {
    
    let songStats = {}; 

    // 1. å…¨ãƒ©ã‚¤ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
    lives.sort((a, b) => new Date(a.date) - new Date(b.date));

    // 2. å…¨ãƒ©ã‚¤ãƒ–ã®ã‚»ãƒˆãƒªã‚’ã‚¹ã‚­ãƒ£ãƒ³
    lives.forEach(live => {
      if (live.setlist && Array.isArray(live.setlist)) {
        live.setlist.forEach(songId => {
          if (!songStats[songId]) {
            songStats[songId] = { count: 0, lastDate: "", lastLive: "" };
          }
          songStats[songId].count += 1;
          songStats[songId].lastDate = live.date;
          songStats[songId].lastLive = live.tour;
        });
      }
    });

    // 3. é›†è¨ˆçµæœã‚’æ›²æƒ…å ±ã¨ç´ä»˜ã‘
    let stats = songs.map(song => {
      const s = songStats[song.id] || { count: 0, lastDate: "-", lastLive: "-" };
      return {
        title: song.title,
        count: s.count,
        lastDate: s.lastDate,
        lastLive: s.lastLive,
        type: song.type === 's' ? 'ğŸ’¿' : 'ğŸ¸'
      };
    });

    // 4. æ¼”å¥å›æ•°é †ã«ä¸¦ã³æ›¿ãˆ
    stats.sort((a, b) => b.count - a.count);

    // 5. è¡¨ç¤ºã‚¨ãƒªã‚¢ã®æç”»ï¼ˆ2æ®µãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰
    let outputHtml = ""; // å¤‰æ•°åã‚’é‡è¤‡ã—ãªã„ã‚ˆã†ã«å¤‰æ›´
    
stats.forEach((s, index) => {
      if (s.count > 0) {
        // divã« onclick="showSongHistory(...)" ã‚’è¿½åŠ ã—ã€æ›²åã‚’é’è‰²ï¼†ä¸‹ç·šã«ã—ã¦ã„ã¾ã™
        outputHtml += `
          <div style="border-bottom: 1px solid #ddd; padding: 10px 5px; cursor: pointer;" onclick="showSongHistory('${String(s.id)}', '${s.title}')">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
              <div style="font-weight: bold; font-size: 1.0em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #007bff; text-decoration: underline;">
                <span style="color: #888; margin-right: 5px; text-decoration: none; display: inline-block;">${index + 1}.</span>
                ${s.type} ${s.title}
              </div>
              <div style="background: #e60012; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; flex-shrink: 0; margin-left: 10px;">
                ${s.count}å›
              </div>
            </div>
            
            <div style="font-size: 0.8em; color: #666; display: flex; flex-wrap: wrap; gap: 8px;">
              <span>ğŸ“… ${s.lastDate}</span>
              <span>ğŸ¤ ${s.lastLive}</span>
            </div>
          </div>
        `;
      }
    });
    
    if (outputHtml === "") outputHtml = "æ¼”å¥å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚";
    statsArea.innerHTML = outputHtml;

  }).catch(err => {
    console.error(err);
    statsArea.innerHTML = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚URLã¾ãŸã¯JSONã®å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
  });
}

// æœªæ¼”å¥æ›²ï¼ˆã‚«ã‚¦ãƒ³ãƒˆãŒ0ã®æ›²ï¼‰ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
function showUnplayedSongs() {
  const masterUrl = "https://thumpman-graffitti.github.io/pwa-test/live_master.json";
  const songsUrl = "https://thumpman-graffitti.github.io/pwa-test/songs_master.json";

  const statsArea = document.getElementById("statsArea");
  statsArea.innerHTML = "æŠ½å‡ºä¸­...";

  Promise.all([
    fetch(masterUrl).then(res => res.json()),
    fetch(songsUrl).then(res => res.json())
  ]).then(([lives, songs]) => {
    
    let playedSongIds = new Set(); 

    // 1. æ¼”å¥ã•ã‚ŒãŸã“ã¨ãŒã‚ã‚‹æ›²ã®IDã‚’ã™ã¹ã¦Setã«å…¥ã‚Œã‚‹
    lives.forEach(live => {
      if (live.setlist && Array.isArray(live.setlist)) {
        live.setlist.forEach(songId => playedSongIds.add(songId));
      }
    });

    // 2. æ¥½æ›²ãƒã‚¹ã‚¿ã®ã†ã¡ã€æ¼”å¥æ¸ˆã¿ã‚»ãƒƒãƒˆã«å«ã¾ã‚Œãªã„æ›²ã ã‘ã‚’æŠ½å‡º
    let unplayedSongs = songs.filter(song => !playedSongIds.has(song.id));

    // 3. è¡¨ç¤ºã‚¨ãƒªã‚¢ã®æç”»
    let outputHtml = "<h3 style='margin-top:0;'>ğŸš« æœªæ¼”å¥ã®æ¥½æ›²ä¸€è¦§</h3>";
    outputHtml += `<p style='font-size:0.8em; color:#666;'>å…¨ ${songs.length} æ›²ä¸­ã€${unplayedSongs.length} æ›²ãŒæœªæ¼”å¥ã§ã™ã€‚</p>`;
    
    unplayedSongs.forEach((s) => {
      outputHtml += `
        <div style="border-bottom: 1px solid #ddd; padding: 8px 5px;">
          <div style="font-weight: bold;">
            ${s.type === 's' ? 'ğŸ’¿' : 'ğŸ¸'} ${s.title}
          </div>
          <div style="font-size: 0.8em; color: #888;">
            åˆå‡º: ${s.source || '-'} / ã‚¢ãƒ«ãƒãƒ : ${s.album || '-'}
          </div>
        </div>
      `;
    });
    
    if (unplayedSongs.length === 0) outputHtml = "ãªã‚“ã¨ã€å…¨æ›²æ¼”å¥æ¸ˆã¿ã§ã™ï¼ğŸ‰";
    statsArea.innerHTML = outputHtml;

  }).catch(err => {
    console.error(err);
    statsArea.innerHTML = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
  });
}  

// ç‰¹å®šã®æ›²ã®æ¼”å¥å±¥æ­´ã‚’ä¸€è¦§è¡¨ç¤ºã™ã‚‹é–¢æ•°ï¼ˆæ¯”è¼ƒãƒ­ã‚¸ãƒƒã‚¯å¼·åŒ–ç‰ˆï¼‰
function showSongHistory(songId, songTitle) {
  const masterUrl = "https://thumpman-graffitti.github.io/pwa-test/live_master.json";
  const statsArea = document.getElementById("statsArea");

  statsArea.innerHTML = `ã€Œ${songTitle}ã€ã®å±¥æ­´ã‚’æ¤œç´¢ä¸­...`;

  fetch(masterUrl)
    .then(res => res.json())
    .then(lives => {
      // æ¤œç´¢å¯¾è±¡ã®IDã‚’å¾¹åº•çš„ã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      const searchTarget = String(songId).trim();

      // ä¸€è‡´ã™ã‚‹ãƒ©ã‚¤ãƒ–ã‚’æŠ½å‡º
      const history = lives.filter(live => {
        if (!live.setlist || !Array.isArray(live.setlist)) return false;
        // setlistå†…ã®å„IDã‚‚å¾¹åº•çš„ã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¦æ¯”è¼ƒ
        return live.setlist.some(id => String(id).trim() === searchTarget);
      });
      
      history.sort((a, b) => new Date(b.date) - new Date(a.date));

      let html = `<div style="margin-bottom: 15px; border-bottom: 2px solid #007bff; padding-bottom: 10px;">
                    <button onclick="showGlobalStats()" style="width: auto; padding: 5px 15px; font-size: 0.8em; background: #eee; border:1px solid #ccc; border-radius:4px;">â† ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«æˆ»ã‚‹</button>
                    <h3 style="margin: 10px 0 5px 0;">ğŸ¸ ã€Œ${songTitle}ã€ã®æ¼”å¥å±¥æ­´</h3>
                    <p style="font-size: 0.85em; color: #666; font-weight:bold;">æ¼”å¥å›æ•°: ${history.length} å›</p>
                  </div>`;

      if (history.length > 0) {
        history.forEach(live => {
          html += `
            <div style="border-bottom: 1px dotted #ccc; padding: 10px 5px; font-size: 0.9em;">
              <div style="font-weight: bold; color: #333;">ğŸ“… ${live.date}</div>
              <div style="margin: 2px 0;">ğŸ¤ ${live.tour}</div>
              <div style="color: #666; font-size: 0.85em;">ğŸ“ ${live.venue}</div>
            </div>
          `;
        });
      } else {
        html += "<p style='color:red;'>å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã¨ã®ç´ä»˜ã‘ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ©ã‚¤ãƒ–ãƒ‡ãƒ¼ã‚¿ã®IDã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>";
      }

      statsArea.innerHTML = html;
      statsArea.scrollTop = 0;
    })
    .catch(err => {
      console.error(err);
      statsArea.innerHTML = "ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
    });
}
  
</script>

</body>
</html>










