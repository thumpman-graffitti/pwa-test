<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="PG Live Log" />
  <title>PG Live Log</title>
  <style>
    body { font-family: sans-serif; padding: 20px; line-height: 1.6; max-width: 800px; margin: auto; }
    input, select, button { display: block; width: 100%; margin-bottom: 10px; padding: 12px; box-sizing: border-box; border-radius: 5px; border: 1px solid #ccc; font-size: 16px; }
    button { cursor: pointer; background: #007bff; color: white; border: none; font-weight: bold; }
    button:hover { background: #0056b3; }
    .secondary-btn { background: #6c757d; }
    .tertiary-btn { background: #28a745; }
    li { margin-bottom: 10px; border-bottom: 1px dotted #ccc; padding-bottom: 8px; list-style: none; }
    .stats-container { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px; }
    .live-card { border-left: 5px solid #007bff; background: #fff; padding: 10px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .loading { text-align: center; color: #666; margin-top: 50px; }
    .encore { color: #dc3545; font-weight: bold; margin-left: 5px; }
    .rank-num { font-weight: bold; color: #555; width: 35px; display: inline-block; }
    .last-played { display: block; font-size: 0.8em; color: #888; margin-left: 35px; }
    .song-title { color: #007bff; text-decoration: underline; cursor: pointer; font-weight: bold; }
    .album-name { font-size: 0.8em; color: #666; margin-left: 5px; }
    label { font-size: 0.9em; color: #555; font-weight: bold; display: block; margin-bottom: 5px; }
    /* åœ°å›³ã‚¿ã‚¤ãƒ«ç”¨ */
    .map-tile:hover { opacity: 0.8; stroke: #ffc107; stroke-width: 2px; }
  </style>
</head>
<body>

<h1>ğŸµ PGDB10</h1>

<div id="loader" class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>

<div id="app-ui" style="display:none;">
  <label>1. ãƒ„ã‚¢ãƒ¼ãƒ»ãƒ©ã‚¤ãƒ–åã‚’é¸æŠï¼š</label>
  <select id="tourSelect">
    <option value="">-- ãƒ„ã‚¢ãƒ¼ã‚’é¸æŠ --</option>
  </select>

  <label>2. å…¬æ¼”æ—¥ã‚’é¸æŠï¼š</label>
  <select id="liveSelect" disabled>
    <option value="">-- å…ˆã«ãƒ„ã‚¢ãƒ¼ã‚’é¸æŠ --</option>
  </select>

  <button onclick="showGlobalStats()" class="secondary-btn">ğŸ“Š å…¨æ¼”å¥æ›²ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤º</button>
  <button onclick="showUnplayedSongs()" class="tertiary-btn">ğŸ”• æœªæ¼”å¥ã®æ›²ä¸€è¦§ã‚’è¡¨ç¤º</button>
  <button onclick="showPrefStats()" class="secondary-btn">ğŸ—¾ éƒ½é“åºœçœŒåˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>

  <div id="displayArea" class="stats-container">
    <p>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰æ“ä½œã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
  </div>
</div>

<script>
  let lives = [];
  let setlists = [];
  let songsMaster = [];

  async function init() {
    try {
      const fetchJson = async (file) => {
        const res = await fetch(file);
        if (!res.ok) throw new Error(`${file} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
        return await res.json();
      };

      const [resLives, resSets, resSongs] = await Promise.all([
        fetchJson('lives.json'),
        fetchJson('setlists.json'),
        fetchJson('songs_master.json')
      ]);

      lives = resLives;
      setlists = resSets;
      songsMaster = resSongs;

      renderTourSelect();
      document.getElementById('loader').style.display = 'none';
      document.getElementById('app-ui').style.display = 'block';
    } catch (error) {
      console.error("Load Error:", error);
      document.getElementById('loader').innerHTML = `<p style="color:red;">èª­ã¿è¾¼ã¿å¤±æ•—: ${error.message}</p>`;
    }
  }

  // ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
  function resetSelectors() {
    document.getElementById('tourSelect').value = "";
    const liveSelect = document.getElementById('liveSelect');
    liveSelect.innerHTML = '<option value="">-- å…ˆã«ãƒ„ã‚¢ãƒ¼ã‚’é¸æŠ --</option>';
    liveSelect.disabled = true;
  }

  function renderTourSelect() {
    const tourSelect = document.getElementById('tourSelect');
    const tourMap = new Map();
    lives.forEach(live => {
      if (!tourMap.has(live.title) || new Date(live.date) > new Date(tourMap.get(live.title))) {
        tourMap.set(live.title, live.date);
      }
    });
    const sortedTours = Array.from(tourMap.keys()).sort((a, b) => new Date(tourMap.get(b)) - new Date(tourMap.get(a)));
    sortedTours.forEach(title => {
      const opt = document.createElement('option');
      opt.value = title;
      opt.textContent = title;
      tourSelect.appendChild(opt);
    });
    tourSelect.addEventListener('change', (e) => { renderLiveSelect(e.target.value); });
  }

  function renderLiveSelect(selectedTitle) {
    const liveSelect = document.getElementById('liveSelect');
    liveSelect.innerHTML = '<option value="">-- å…¬æ¼”æ—¥ã‚’é¸æŠ --</option>';
    if (!selectedTitle) { liveSelect.disabled = true; return; }
    const filteredLives = lives.filter(l => l.title === selectedTitle).sort((a, b) => new Date(b.date) - new Date(a.date));
    filteredLives.forEach(live => {
      const opt = document.createElement('option');
      opt.value = live.id;
      opt.textContent = `${live.date} ã€${live.venue}ã€‘`;
      liveSelect.appendChild(opt);
    });
    liveSelect.disabled = false;
    liveSelect.onchange = (e) => { if (e.target.value) showSetlist(e.target.value); };
  }

  function showSetlist(liveId) {
    const targetLiveId = String(liveId).padStart(4, '0');
    const live = lives.find(l => String(l.id).padStart(4, '0') === targetLiveId);
    const filteredSet = setlists.filter(s => String(s.live_id).padStart(4, '0') === targetLiveId).sort((a, b) => a.order - b.order);
    const area = document.getElementById('displayArea');
    let html = `<h2>${live.title}</h2><p>ğŸ“… ${live.date} ğŸ“ ${live.venue}</p><hr><ul>`;
    if (filteredSet.length === 0) html += `<p>ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>`;
    filteredSet.forEach(item => {
      html += `<li>${item.order}. <strong>${item.song_title}</strong>${item.is_encore ? '<span class="encore">(Encore)</span>' : ''}</li>`;
    });
    area.innerHTML = html + `</ul>`;
  }

  function showGlobalStats() {
    resetSelectors();
    const counts = {};
    const lastLiveMap = {};
    setlists.forEach(s => {
      counts[s.song_id] = (counts[s.song_id] || 0) + 1;
      const currentLive = lives.find(l => String(l.id).padStart(4, '0') === String(s.live_id).padStart(4, '0'));
      if (currentLive) {
        if (!lastLiveMap[s.song_id] || new Date(currentLive.date) > new Date(lastLiveMap[s.song_id].date)) {
          lastLiveMap[s.song_id] = currentLive;
        }
      }
    });
    const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
    const area = document.getElementById('displayArea');
    let html = `<h2>ğŸ“Š å…¨æ¼”å¥æ›²ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2><ul>`;
    let rank = 1;
    sorted.forEach(([songId, count], index) => {
      if (index > 0 && count < sorted[index - 1][1]) rank = index + 1;
      const song = songsMaster.find(sm => String(sm.id).padStart(3, '0') === String(songId).padStart(3, '0'));
      let title = song ? song.title : (setlists.find(s => s.song_id === songId)?.song_title || `ID:${songId}`);
      title = title.replace(/^"/g, "").split('(')[0].split('ï¼ˆ')[0].trim();
      const lastLive = lastLiveMap[songId];
      html += `<li><span class="rank-num">${rank}ä½</span><span class="song-title" onclick="showSongHistory('${songId}', '${title.replace(/'/g, "\\'")}')">${title}</span> (${count}å›)${lastLive ? `<span class="last-played">æœ€çµ‚æ¼”å¥: ${lastLive.date} ã€Œ${lastLive.title}ã€</span>` : ''}</li>`;
    });
    area.innerHTML = html + `</ul>`;
  }

  function showUnplayedSongs() {
    resetSelectors();
    const playedSongIds = new Set(setlists.map(s => String(s.song_id).padStart(3, '0')));
    const unplayed = songsMaster.filter(sm => !playedSongIds.has(String(sm.id).padStart(3, '0'))).sort((a, b) => (a.title || "").localeCompare(b.title || "", 'ja'));
    const area = document.getElementById('displayArea');
    let html = `<h2>ğŸ”• æœªæ¼”å¥ã®æ›²ä¸€è¦§ (${unplayed.length}æ›²)</h2><ul>`;
    if (unplayed.length === 0) { html += `<p>ã™ã¹ã¦ã®æ›²ãŒæ¼”å¥æ¸ˆã¿ã§ã™ï¼</p>`; } 
    else { unplayed.forEach(song => {
        let title = (song.title || "åç§°ä¸æ˜").replace(/^"/g, "").split('(')[0].split('ï¼ˆ')[0].trim();
        html += `<li>ãƒ»${title} <span class="album-name">(${song.album || 'ä¸æ˜'})</span></li>`;
    }); }
    area.innerHTML = html + `</ul>`;
  }

  function showSongHistory(songId, songTitle) {
    const history = setlists.filter(s => String(s.song_id).padStart(3, '0') === String(songId).padStart(3, '0'));
    const area = document.getElementById('displayArea');
    let html = `<h3>ğŸ¸ ã€Œ${songTitle}ã€ã®æ¼”å¥å±¥æ­´</h3><button onclick="showGlobalStats()" class="secondary-btn" style="width:auto; padding:5px 15px;">â† ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«æˆ»ã‚‹</button><br><br>`;
    history.sort((a,b) => {
      const liveA = lives.find(l => String(l.id).padStart(4, '0') === String(a.live_id).padStart(4, '0'));
      const liveB = lives.find(l => String(l.id).padStart(4, '0') === String(b.live_id).padStart(4, '0'));
      return new Date(liveB.date) - new Date(liveA.date);
    }).forEach(h => {
      const live = lives.find(l => String(l.id).padStart(4, '0') === String(h.live_id).padStart(4, '0'));
      if (live) { html += `<div class="live-card"><b>ğŸ“… ${live.date}</b><br>ğŸ¤ ${live.title}<br><small>ğŸ“ ${live.venue}</small></div>`; }
    });
    area.innerHTML = html;
  }

  // --- éƒ½é“åºœçœŒãƒ©ãƒ³ã‚­ãƒ³ã‚° & ã‚¿ã‚¤ãƒ«ãƒãƒƒãƒ— ---

  function showPrefStats() {
    resetSelectors();
    const area = document.getElementById('displayArea');
    
    const counts = {};
    lives.forEach(live => {
      let pref = (live.prefecture || "ä¸æ˜").trim();
      if (pref !== "ä¸æ˜" && !pref.endsWith("éƒ½") && !pref.endsWith("é“") && !pref.endsWith("åºœ") && !pref.endsWith("çœŒ")) {
          if (pref === "æ±äº¬") pref = "æ±äº¬éƒ½";
          else if (pref === "å¤§é˜ª" || pref === "äº¬éƒ½") pref += "åºœ";
          else if (pref === "åŒ—æµ·é“") pref = "åŒ—æµ·é“";
          else pref += "çœŒ";
      }
      counts[pref] = (counts[pref] || 0) + 1;
    });

    const maxCount = Math.max(...Object.values(counts), 1);

    // ã‚¿ã‚¤ãƒ«ãƒãƒƒãƒ—å®šç¾©
    const prefTiles = [
      { name: "åŒ—æµ·é“", x: 400, y: 0 },
      { name: "é’æ£®çœŒ", x: 400, y: 70 }, { name: "å²©æ‰‹çœŒ", x: 400, y: 115 }, { name: "ç§‹ç”°çœŒ", x: 350, y: 115 },
      { name: "å®®åŸçœŒ", x: 400, y: 160 }, { name: "å±±å½¢çœŒ", x: 350, y: 160 }, { name: "ç¦å³¶çœŒ", x: 400, y: 205 },
      { name: "èŒ¨åŸçœŒ", x: 400, y: 250 }, { name: "æ ƒæœ¨çœŒ", x: 350, y: 250 }, { name: "ç¾¤é¦¬çœŒ", x: 300, y: 250 },
      { name: "åŸ¼ç‰çœŒ", x: 300, y: 295 }, { name: "åƒè‘‰çœŒ", x: 400, y: 295 }, { name: "æ±äº¬éƒ½", x: 350, y: 295 }, { name: "ç¥å¥ˆå·çœŒ", x: 350, y: 340 },
      { name: "æ–°æ½ŸçœŒ", x: 300, y: 205 }, { name: "å¯Œå±±çœŒ", x: 250, y: 205 }, { name: "çŸ³å·çœŒ", x: 200, y: 205 }, { name: "ç¦äº•çœŒ", x: 150, y: 205 },
      { name: "å±±æ¢¨çœŒ", x: 250, y: 295 }, { name: "é•·é‡çœŒ", x: 250, y: 250 }, { name: "å²é˜œçœŒ", x: 200, y: 250 }, { name: "é™å²¡çœŒ", x: 300, y: 340 }, { name: "æ„›çŸ¥çœŒ", x: 250, y: 340 },
      { name: "ä¸‰é‡çœŒ", x: 200, y: 340 }, { name: "æ»‹è³€çœŒ", x: 150, y: 250 }, { name: "äº¬éƒ½åºœ", x: 100, y: 250 }, { name: "å¤§é˜ªåºœ", x: 100, y: 295 }, { name: "å…µåº«çœŒ", x: 50, y: 250 }, { name: "å¥ˆè‰¯çœŒ", x: 150, y: 295 }, { name: "å’Œæ­Œå±±çœŒ", x: 150, y: 340 },
      { name: "é³¥å–çœŒ", x: 50, y: 205 }, { name: "å³¶æ ¹çœŒ", x: 0, y: 205 }, { name: "å²¡å±±çœŒ", x: 50, y: 295 }, { name: "åºƒå³¶çœŒ", x: 0, y: 295 }, { name: "å±±å£çœŒ", x: 0, y: 340 },
      { name: "å¾³å³¶çœŒ", x: 100, y: 410 }, { name: "é¦™å·çœŒ", x: 50, y: 410 }, { name: "æ„›åª›çœŒ", x: 0, y: 410 }, { name: "é«˜çŸ¥çœŒ", x: 50, y: 455 },
      { name: "ç¦å²¡çœŒ", x: 0, y: 480 }, { name: "ä½è³€çœŒ", x: 0, y: 525 }, { name: "é•·å´çœŒ", x: 0, y: 570 }, { name: "ç†Šæœ¬çœŒ", x: 50, y: 525 }, { name: "å¤§åˆ†çœŒ", x: 50, y: 480 }, { name: "å®®å´çœŒ", x: 50, y: 570 }, { name: "é¹¿å…å³¶çœŒ", x: 0, y: 615 }, { name: "æ²–ç¸„çœŒ", x: 150, y: 615 }
    ];

    let mapSvg = `<svg viewBox="-10 -10 480 680" style="width:100%; height:auto;">`;
    prefTiles.forEach(p => {
      const count = counts[p.name] || 0;
      const alpha = count > 0 ? (count / maxCount) * 0.7 + 0.3 : 0.05;
      const color = count > 0 ? `rgba(0, 123, 255, ${alpha})` : "#f0f0f0";
      const shortName = p.name.replace(/çœŒ|åºœ|æ±äº¬éƒ½/, "");
      mapSvg += `
        <g onclick="showPrefHistory('${p.name}')" style="cursor:pointer" class="map-tile">
          <rect x="${p.x}" y="${p.y}" width="42" height="42" rx="4" fill="${color}" stroke="#ddd" stroke-width="1" />
          <text x="${p.x + 21}" y="${p.y + 26}" fill="${count > (maxCount/2) ? 'white' : '#333'}" font-size="10" text-anchor="middle" pointer-events="none">${shortName}</text>
        </g>`;
    });
    mapSvg += `</svg>`;

    let html = `<h2>ğŸ—¾ éƒ½é“åºœçœŒåˆ¥ãƒ©ã‚¤ãƒ–ãƒãƒƒãƒ—</h2>`;
    html += `<div style="background:#fff; padding:10px; border-radius:8px; margin-bottom:20px; box-shadow:inset 0 0 10px rgba(0,0,0,0.05);">${mapSvg}</div>`;
    html += `<hr><h3>ğŸ“Š é–‹å‚¬å›æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3><ul style="padding:0;">`;
    
    const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
    let rank = 1;
    sorted.forEach(([pref, count], index) => {
      if (index > 0 && count < sorted[index - 1][1]) rank = index + 1;
      html += `
        <li onclick="showPrefHistory('${pref}')" 
            style="cursor:pointer; list-style:none; padding:15px; background:#fff; margin-bottom:8px; border-radius:8px; border:1px solid #ddd; display:flex; justify-content:space-between; align-items:center;">
          <div><span class="rank-num">${rank}ä½</span> <span style="color:#007bff; font-weight:bold; text-decoration:underline;">${pref}</span></div>
          <div style="font-weight:bold;">${count}å› ã€‰</div>
        </li>`;
    });
    
    area.innerHTML = html + `</ul>`;
  }

  function showPrefHistory(prefName) {
    const history = lives.filter(l => {
      let p = (l.prefecture || "").trim();
      if (!p.endsWith("éƒ½") && !p.endsWith("é“") && !p.endsWith("åºœ") && !p.endsWith("çœŒ")) {
          if (p === "æ±äº¬") p = "æ±äº¬éƒ½"; else if (p === "å¤§é˜ª" || p === "äº¬éƒ½") p += "åºœ"; else if (p === "åŒ—æµ·é“") p = "åŒ—æµ·é“"; else if(p) p += "çœŒ";
      }
      return p === prefName;
    }).sort((a, b) => new Date(b.date) - new Date(a.date));

    const area = document.getElementById('displayArea');
    let html = `<h3>ğŸ“ ${prefName} ã§ã®é–‹å‚¬å±¥æ­´</h3>`;
    html += `<button onclick="showPrefStats()" class="secondary-btn" style="width:auto; padding:8px 20px; margin-bottom:15px;">â† ãƒãƒƒãƒ—ã«æˆ»ã‚‹</button>`;
    
    history.forEach(live => {
      html += `<div class="live-card"><b>ğŸ“… ${live.date}</b><br>ğŸ¤ ${live.title}<br><small>ğŸ“ ${live.venue}</small></div>`;
    });
    area.innerHTML = html;
    window.scrollTo(0, 0);
  }

  init();
</script>
</body>
</html>
