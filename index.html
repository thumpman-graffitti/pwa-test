<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="PG Live Log" />
  <title>PG Live Log</title>
  <style>
    body { font-family: sans-serif; padding: 20px; line-height: 1.6; max-width: 800px; margin: auto; }
    input, select, button { display: block; width: 100%; margin-bottom: 10px; padding: 12px; box-sizing: border-box; border-radius: 5px; border: 1px solid #ccc; font-size: 16px; }
    button { cursor: pointer; background: #007bff; color: white; border: none; font-weight: bold; }
    button:hover { background: #0056b3; }
    .secondary-btn { background: #6c757d; }
    li { margin-bottom: 10px; border-bottom: 1px dotted #ccc; padding-bottom: 5px; list-style: none; }
    .stats-container { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px; }
    .live-card { border-left: 5px solid #007bff; background: #fff; padding: 10px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .loading { text-align: center; color: #666; margin-top: 50px; }
    .encore { color: #dc3545; font-weight: bold; margin-left: 5px; }
  </style>
</head>
<body>

<h1>ğŸµ PG DB</h1>

<div id="loader" class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>

<div id="app-ui" style="display:none;">
  <label>ãƒ©ã‚¤ãƒ–å±¥æ­´ã‚’è¡¨ç¤ºï¼š</label>
  <select id="liveSelect">
    <option value="">-- ãƒ©ã‚¤ãƒ–ã‚’é¸æŠ --</option>
  </select>

  <button onclick="showGlobalStats()" class="secondary-btn">ğŸ“Š å…¨æ¼”å¥æ›²ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤º</button>

  <div id="displayArea" class="stats-container">
    <p>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ãƒ©ã‚¤ãƒ–ã‚’é¸æŠã™ã‚‹ã‹ã€ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤ºã—ã¦ãã ã•ã„ã€‚</p>
  </div>
</div>

<script>
  let lives = [];
  let setlists = [];
  let songsMaster = [];

  // 1. JSONãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
  async function init() {
    try {
      const [resLives, resSets, resSongs] = await Promise.all([
        fetch('lives.json'),
        fetch('setlists.json'),
        fetch('songs_master.json')
      ]);

      lives = await resLives.json();
      setlists = await resSets.json();
      songsMaster = await resSongs.json();

      renderLiveSelect();
      document.getElementById('loader').style.display = 'none';
      document.getElementById('app-ui').style.display = 'block';
    } catch (error) {
      document.getElementById('loader').innerHTML = 
        `<p style="color:red;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>lives.json, setlists.json, songs_master.json ãŒGitHubä¸Šã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>`;
      console.error(error);
    }
  }

  // 2. ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®ç”Ÿæˆ
  function renderLiveSelect() {
    const select = document.getElementById('liveSelect');
    // æ—¥ä»˜ã®æ–°ã—ã„é †ã«ä¸¦ã³æ›¿ãˆã¦è¡¨ç¤º
    const sortedLives = [...lives].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    sortedLives.forEach(live => {
      const opt = document.createElement('option');
      opt.value = live.id;
      opt.textContent = `${live.date} ${live.title}`;
      select.appendChild(opt);
    });

    select.addEventListener('change', (e) => {
      if (e.target.value) showSetlist(e.target.value);
    });
  }

  // 3. ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆè¡¨ç¤º
  function showSetlist(liveId) {
    const live = lives.find(l => l.id === liveId);
    const filteredSet = setlists.filter(s => s.live_id === liveId).sort((a, b) => a.order - b.order);
    const area = document.getElementById('displayArea');

    let html = `<h2>${live.title}</h2>`;
    html += `<p>ğŸ“… ${live.date} ğŸ“ ${live.venue}</p>`;
    if(live.description) html += `<p style="font-size:0.9em; color:#666;">ğŸ“ ${live.description}</p>`;
    html += `<hr><ul>`;

    filteredSet.forEach(item => {
      html += `<li>${item.order}. <strong>${item.song_title}</strong>${item.is_encore ? '<span class="encore"> (Encore)</span>' : ''}</li>`;
    });

    html += `</ul>`;
    area.innerHTML = html;
  }

  // 4. ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
  function showGlobalStats() {
    const counts = {};
    setlists.forEach(s => {
      counts[s.song_id] = (counts[s.song_id] || 0) + 1;
    });

    const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
    const area = document.getElementById('displayArea');

    let html = `<h2>ğŸ“Š å…¨æ¼”å¥æ›²ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2><p style="font-size:0.8em;">ï¼ˆæ›²åã‚¯ãƒªãƒƒã‚¯ã§æ¼”å¥å±¥æ­´ã‚’è¡¨ç¤ºï¼‰</p><ul>`;
    
    sorted.forEach(([songId, count]) => {
      // songsMasterã‹ã‚‰æ›²æƒ…å ±ã‚’æ¢ã™ï¼ˆIDãŒæ•°å€¤ã‹æ–‡å­—åˆ—ã‹æ›–æ˜§ãªå ´åˆã‚’è€ƒæ…®ã—ã¦æ¯”è¼ƒï¼‰
      const song = songsMaster.find(sm => String(sm.id).padStart(3, '0') === String(songId).padStart(3, '0'));
      const title = song ? song.title : (setlists.find(s => s.song_id === songId)?.song_title || `Unknown ID:${songId}`);
      
      html += `<li onclick="showSongHistory('${songId}', '${title}')" style="cursor:pointer; color:#007bff; text-decoration:underline;">
                ${title} (${count}å›)
              </li>`;
    });
    
    html += `</ul>`;
    area.innerHTML = html;
  }

  // 5. ç‰¹å®šã®æ›²ã®æ¼”å¥å±¥æ­´
  function showSongHistory(songId, songTitle) {
    const history = setlists.filter(s => String(s.song_id).padStart(3, '0') === String(songId).padStart(3, '0'));
    const area = document.getElementById('displayArea');

    let html = `<h3>ğŸ¸ ã€Œ${songTitle}ã€ã®æ¼”å¥å±¥æ­´</h3>`;
    html += `<button onclick="showGlobalStats()" class="secondary-btn" style="width:auto; padding:5px 15px;">â† ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«æˆ»ã‚‹</button><br><br>`;
    
    history.forEach(h => {
      const live = lives.find(l => l.id === h.live_id);
      if (live) {
        html += `
          <div class="live-card">
            <div style="font-weight:bold;">ğŸ“… ${live.date}</div>
            <div>ğŸ¤ ${live.title}</div>
            <div style="font-size:0.8em; color:#666;">ğŸ“ ${live.venue} / ${h.is_encore ? 'ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«' : 'æœ¬ç·¨'}</div>
          </div>`;
      }
    });
    area.innerHTML = html;
  }

  // åˆæœŸåŒ–å®Ÿè¡Œ
  init();

  // Service Workerç™»éŒ²
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').then(() => console.log('SW registered'));
  }
</script>

</body>
</html>
