<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="PG Live Log" />
  <title>PG Live Log</title>
  <script src="https://unpkg.com/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://unpkg.com/japanmap@1.0.2/jquery.japanmap.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; line-height: 1.6; max-width: 800px; margin: auto; }
    input, select, button { display: block; width: 100%; margin-bottom: 10px; padding: 12px; box-sizing: border-box; border-radius: 5px; border: 1px solid #ccc; font-size: 16px; }
    button { cursor: pointer; background: #007bff; color: white; border: none; font-weight: bold; }
    button:hover { background: #0056b3; }
    .secondary-btn { background: #6c757d; }
    .tertiary-btn { background: #28a745; }
    li { margin-bottom: 10px; border-bottom: 1px dotted #ccc; padding-bottom: 8px; list-style: none; }
    .stats-container { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px; }
    .live-card { border-left: 5px solid #007bff; background: #fff; padding: 10px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .loading { text-align: center; color: #666; margin-top: 50px; }
    .encore { color: #dc3545; font-weight: bold; margin-left: 5px; }
    .rank-num { font-weight: bold; color: #555; width: 35px; display: inline-block; }
    .last-played { display: block; font-size: 0.8em; color: #888; margin-left: 35px; }
    .song-title { color: #007bff; text-decoration: underline; cursor: pointer; font-weight: bold; }
    .album-name { font-size: 0.8em; color: #666; margin-left: 5px; }
    label { font-size: 0.9em; color: #555; font-weight: bold; display: block; margin-bottom: 5px; }
    /* åœ°å›³ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #map-canvas { background: white; border-radius: 8px; margin-bottom: 20px; padding: 10px; display: flex; justify-content: center; }
  </style>
</head>
<body>

<h1>ğŸµ PGDB9</h1>

<div id="loader" class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>

<div id="app-ui" style="display:none;">
  <label>1. ãƒ„ã‚¢ãƒ¼ãƒ»ãƒ©ã‚¤ãƒ–åã‚’é¸æŠï¼š</label>
  <select id="tourSelect">
    <option value="">-- ãƒ„ã‚¢ãƒ¼ã‚’é¸æŠ --</option>
  </select>

  <label>2. å…¬æ¼”æ—¥ã‚’é¸æŠï¼š</label>
  <select id="liveSelect" disabled>
    <option value="">-- å…ˆã«ãƒ„ã‚¢ãƒ¼ã‚’é¸æŠ --</option>
  </select>

  <button onclick="showGlobalStats()" class="secondary-btn">ğŸ“Š å…¨æ¼”å¥æ›²ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤º</button>
  <button onclick="showUnplayedSongs()" class="tertiary-btn">ğŸ”• æœªæ¼”å¥ã®æ›²ä¸€è¦§ã‚’è¡¨ç¤º</button>
  <button onclick="showPrefStats()" class="secondary-btn">ğŸ—¾ éƒ½é“åºœçœŒåˆ¥ãƒãƒƒãƒ—ãƒ»ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>

  <div id="displayArea" class="stats-container">
    <p>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰æ“ä½œã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
  </div>
</div>

<script>
  let lives = [];
  let setlists = [];
  let songsMaster = [];

  async function init() {
    try {
      const fetchJson = async (file) => {
        const res = await fetch(file);
        if (!res.ok) throw new Error(`${file} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
        return await res.json();
      };

      const [resLives, resSets, resSongs] = await Promise.all([
        fetchJson('lives.json'),
        fetchJson('setlists.json'),
        fetchJson('songs_master.json')
      ]);

      lives = resLives;
      setlists = resSets;
      songsMaster = resSongs;

      renderTourSelect();
      document.getElementById('loader').style.display = 'none';
      document.getElementById('app-ui').style.display = 'block';
    } catch (error) {
      console.error("Load Error:", error);
      document.getElementById('loader').innerHTML = `<p style="color:red;">èª­ã¿è¾¼ã¿å¤±æ•—: ${error.message}</p>`;
    }
  }

  function renderTourSelect() {
    const tourSelect = document.getElementById('tourSelect');
    const tourMap = new Map();
    lives.forEach(live => {
      if (!tourMap.has(live.title) || new Date(live.date) > new Date(tourMap.get(live.title))) {
        tourMap.set(live.title, live.date);
      }
    });
    const sortedTours = Array.from(tourMap.keys()).sort((a, b) => new Date(tourMap.get(b)) - new Date(tourMap.get(a)));
    sortedTours.forEach(title => {
      const opt = document.createElement('option');
      opt.value = title;
      opt.textContent = title;
      tourSelect.appendChild(opt);
    });
    tourSelect.addEventListener('change', (e) => { renderLiveSelect(e.target.value); });
  }

  function renderLiveSelect(selectedTitle) {
    const liveSelect = document.getElementById('liveSelect');
    liveSelect.innerHTML = '<option value="">-- å…¬æ¼”æ—¥ã‚’é¸æŠ --</option>';
    if (!selectedTitle) { liveSelect.disabled = true; return; }
    const filteredLives = lives.filter(l => l.title === selectedTitle).sort((a, b) => new Date(b.date) - new Date(a.date));
    filteredLives.forEach(live => {
      const opt = document.createElement('option');
      opt.value = live.id;
      opt.textContent = `${live.date} ã€${live.venue}ã€‘`;
      liveSelect.appendChild(opt);
    });
    liveSelect.disabled = false;
    liveSelect.onchange = (e) => { if (e.target.value) showSetlist(e.target.value); };
  }

  function showSetlist(liveId) {
    const targetLiveId = String(liveId).padStart(4, '0');
    const live = lives.find(l => String(l.id).padStart(4, '0') === targetLiveId);
    const filteredSet = setlists.filter(s => String(s.live_id).padStart(4, '0') === targetLiveId).sort((a, b) => a.order - b.order);
    const area = document.getElementById('displayArea');
    let html = `<h2>${live.title}</h2><p>ğŸ“… ${live.date} ğŸ“ ${live.venue}</p><hr><ul>`;
    if (filteredSet.length === 0) html += `<p>ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>`;
    filteredSet.forEach(item => {
      html += `<li>${item.order}. <strong>${item.song_title}</strong>${item.is_encore ? '<span class="encore">(Encore)</span>' : ''}</li>`;
    });
    area.innerHTML = html + `</ul>`;
  }

  function showGlobalStats() {
    const counts = {};
    const lastLiveMap = {};
    setlists.forEach(s => {
      counts[s.song_id] = (counts[s.song_id] || 0) + 1;
      const currentLive = lives.find(l => String(l.id).padStart(4, '0') === String(s.live_id).padStart(4, '0'));
      if (currentLive) {
        if (!lastLiveMap[s.song_id] || new Date(currentLive.date) > new Date(lastLiveMap[s.song_id].date)) {
          lastLiveMap[s.song_id] = currentLive;
        }
      }
    });
    const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
    const area = document.getElementById('displayArea');
    let html = `<h2>ğŸ“Š å…¨æ¼”å¥æ›²ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2><ul>`;
    let rank = 1;
    sorted.forEach(([songId, count], index) => {
      if (index > 0 && count < sorted[index - 1][1]) rank = index + 1;
      const song = songsMaster.find(sm => String(sm.id).padStart(3, '0') === String(songId).padStart(3, '0'));
      let title = song ? song.title : (setlists.find(s => s.song_id === songId)?.song_title || `ID:${songId}`);
      title = title.replace(/^"/g, "").split('(')[0].split('ï¼ˆ')[0].trim();
      const lastLive = lastLiveMap[songId];
      html += `<li><span class="rank-num">${rank}ä½</span><span class="song-title" onclick="showSongHistory('${songId}', '${title.replace(/'/g, "\\'")}')">${title}</span> (${count}å›)${lastLive ? `<span class="last-played">æœ€çµ‚æ¼”å¥: ${lastLive.date} ã€Œ${lastLive.title}ã€</span>` : ''}</li>`;
    });
    area.innerHTML = html + `</ul>`;
  }

  function showUnplayedSongs() {
    const playedSongIds = new Set(setlists.map(s => String(s.song_id).padStart(3, '0')));
    const unplayed = songsMaster.filter(sm => !playedSongIds.has(String(sm.id).padStart(3, '0'))).sort((a, b) => (a.title || "").localeCompare(b.title || "", 'ja'));
    const area = document.getElementById('displayArea');
    let html = `<h2>ğŸ”• æœªæ¼”å¥ã®æ›²ä¸€è¦§ (${unplayed.length}æ›²)</h2><ul>`;
    if (unplayed.length === 0) { html += `<p>ã™ã¹ã¦ã®æ›²ãŒæ¼”å¥æ¸ˆã¿ã§ã™ï¼</p>`; } 
    else { unplayed.forEach(song => {
        let title = (song.title || "åç§°ä¸æ˜").replace(/^"/g, "").split('(')[0].split('ï¼ˆ')[0].trim();
        html += `<li>ãƒ»${title} <span class="album-name">(${song.album || 'ä¸æ˜'})</span></li>`;
    }); }
    area.innerHTML = html + `</ul>`;
  }

  function showSongHistory(songId, songTitle) {
    const history = setlists.filter(s => String(s.song_id).padStart(3, '0') === String(songId).padStart(3, '0'));
    const area = document.getElementById('displayArea');
    let html = `<h3>ğŸ¸ ã€Œ${songTitle}ã€ã®æ¼”å¥å±¥æ­´</h3><button onclick="showGlobalStats()" class="secondary-btn" style="width:auto; padding:5px 15px;">â† ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«æˆ»ã‚‹</button><br><br>`;
    history.sort((a,b) => {
      const liveA = lives.find(l => String(l.id).padStart(4, '0') === String(a.live_id).padStart(4, '0'));
      const liveB = lives.find(l => String(l.id).padStart(4, '0') === String(b.live_id).padStart(4, '0'));
      return new Date(liveB.date) - new Date(liveA.date);
    }).forEach(h => {
      const live = lives.find(l => String(l.id).padStart(4, '0') === String(h.live_id).padStart(4, '0'));
      if (live) { html += `<div class="live-card"><b>ğŸ“… ${live.date}</b><br>ğŸ¤ ${live.title}<br><small>ğŸ“ ${live.venue}</small></div>`; }
    });
    area.innerHTML = html;
  }

  // --- éƒ½é“åºœçœŒãƒãƒƒãƒ—è¡¨ç¤ºæ©Ÿèƒ½ ---


  // éƒ½é“åºœçœŒåˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
  function showPrefStats() {
    const area = document.getElementById('displayArea');
    
    // 1. éƒ½é“åºœçœŒãƒ‡ãƒ¼ã‚¿ã®é›†è¨ˆ
    const counts = {};
    lives.forEach(live => {
      let pref = (live.prefecture || "ä¸æ˜").trim();
      // ã€Œåºƒå³¶ã€ã‚’ã€Œåºƒå³¶çœŒã€ã«çµ±ä¸€ã™ã‚‹ãªã©ã®ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°
      if (pref !== "ä¸æ˜" && !pref.endsWith("éƒ½") && !pref.endsWith("é“") && !pref.endsWith("åºœ") && !pref.endsWith("çœŒ")) {
          if (pref === "æ±äº¬") pref = "æ±äº¬éƒ½";
          else if (pref === "å¤§é˜ª" || pref === "äº¬éƒ½") pref += "åºœ";
          else if (pref === "åŒ—æµ·é“") pref = "åŒ—æµ·é“";
          else pref += "çœŒ";
      }
      counts[pref] = (counts[pref] || 0) + 1;
    });

    // 2. é™é †ï¼ˆå›æ•°ãŒå¤šã„é †ï¼‰ã«ä¸¦ã¹æ›¿ãˆ
    const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);

    // 3. HTMLã®ç”Ÿæˆ
    let html = `<h2>ğŸ—¾ éƒ½é“åºœçœŒåˆ¥ é–‹å‚¬ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>`;
    html += `<p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">â€»éƒ½é“åºœçœŒåã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨å±¥æ­´ã‚’è¡¨ç¤ºã—ã¾ã™</p>`;
    html += `<ul style="padding: 0;">`;
    
    let rank = 1;
    sorted.forEach(([pref, count], index) => {
      // åŒç‡é †ä½ã®è¨ˆç®—
      if (index > 0 && count < sorted[index - 1][1]) rank = index + 1;
      
      // ã‚¿ãƒƒãƒ—ã—ã‚„ã™ã„ã‚ˆã†ã«å¤§ãã‚ã®ãƒœã‚¿ãƒ³é¢¨ãƒªã‚¹ãƒˆã«ã™ã‚‹
      html += `
        <li onclick="showPrefHistory('${pref}')" 
            style="cursor:pointer; 
                   list-style:none; 
                   padding: 15px; 
                   background:#fff; 
                   margin-bottom:8px; 
                   border-radius:8px; 
                   border:1px solid #ddd; 
                   box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                   display:flex; 
                   justify-content:space-between; 
                   align-items:center;">
          <div>
            <span class="rank-num" style="width: 45px; display: inline-block;">${rank}ä½</span>
            <span style="color:#007bff; font-weight:bold; font-size: 1.1em; text-decoration:underline;">${pref}</span>
          </div>
          <div style="font-weight:bold; color: #555;">${count}å› ã€‰</div>
        </li>`;
    });
    
    area.innerHTML = html + `</ul>`;
  }

  // ç‰¹å®šã®éƒ½é“åºœçœŒã®å±¥æ­´ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
  function showPrefHistory(prefName) {
    // ãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°ï¼ˆå¿µã®ãŸã‚å±¥æ­´è¡¨ç¤ºæ™‚ã‚‚æ•´åˆæ€§ã‚’ã¨ã‚‹ï¼‰
    const history = lives.filter(l => {
      let p = (l.prefecture || "ä¸æ˜").trim();
      if (p !== "ä¸æ˜" && !p.endsWith("éƒ½") && !p.endsWith("é“") && !p.endsWith("åºœ") && !p.endsWith("çœŒ")) {
          if (p === "æ±äº¬") p = "æ±äº¬éƒ½";
          else if (p === "å¤§é˜ª" || p === "äº¬éƒ½") p += "åºœ";
          else if (p === "åŒ—æµ·é“") p = "åŒ—æµ·é“";
          else p += "çœŒ";
      }
      return p === prefName;
    }).sort((a, b) => new Date(b.date) - new Date(a.date));

    const area = document.getElementById('displayArea');
    let html = `<h3>ğŸ“ ${prefName} ã§ã®é–‹å‚¬å±¥æ­´</h3>`;
    html += `<button onclick="showPrefStats()" class="secondary-btn" style="width:auto; padding:8px 20px; margin-bottom:15px;">â† ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«æˆ»ã‚‹</button>`;
    
    if (history.length === 0) {
      html += `<p>è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
    } else {
      history.forEach(live => {
        html += `
          <div class="live-card">
            <b style="font-size: 1.1em;">ğŸ“… ${live.date}</b><br>
            <span style="color: #333;">ğŸ¤ ${live.title}</span><br>
            <small style="color: #666;">ğŸ“ ${live.venue}</small>
          </div>`;
      });
    }
    area.innerHTML = html;
    // ç”»é¢ä¸Šéƒ¨ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    window.scrollTo(0, 0);
  }



  init();
</script>
</body>
</html>
