<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="PG Live Log" />
  <title>PG Live Log</title>
  <style>
    body { font-family: sans-serif; padding: 20px; line-height: 1.6; }
    input, select, button { display: block; width: 100%; margin-bottom: 10px; padding: 10px; box-sizing: border-box; }
    button { cursor: pointer; background: #f0f0f0; border: 1px solid #ccc; }
    .delete-btn { background: #ffcccc; border: 1px solid #ff0000; width: auto; display: inline; padding: 2px 8px; margin-left: 10px; }
    li { margin-bottom: 10px; border-bottom: 1px dotted #ccc; padding-bottom: 5px; }
  </style>
</head>
<body>

<h1>ğŸµ PG ãƒ©ã‚¤ãƒ–å±¥æ­´</h1>

<label>ãƒ©ã‚¤ãƒ–ã‚’é¸æŠï¼š</label>
<select id="masterSelect">
  <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
</select>

<input id="memo" type="text" placeholder="åº§å¸­ãƒ»ãƒ¡ãƒ¢ï¼ˆä¾‹ï¼šã‚¢ãƒªãƒ¼ãƒŠA5ï¼‰" />
<button onclick="saveLive()" style="background: #e1f5fe;">âœ¨ å‚åŠ ç™»éŒ²</button>

<hr>

<button onclick="exportData()">ğŸ“¤ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆå…±æœ‰ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ï¼‰</button>
<input type="file" id="importFile" accept=".json" onchange="importData()" />
<button onclick="testClear()" style="color: red;">ğŸ§ª å…¨å‰Šé™¤ãƒ†ã‚¹ãƒˆ</button>

<h2>å‚åŠ å±¥æ­´</h2>
<ul id="list"></ul>

<script>
  let db;

  // DBåˆæœŸåŒ–
  const request = indexedDB.open("pgLiveDB", 1);
  request.onupgradeneeded = (event) => {
    db = event.target.result;
    if (!db.objectStoreNames.contains("lives")) {
      db.createObjectStore("lives", { keyPath: "id", autoIncrement: true });
    }
  };
  request.onsuccess = (event) => {
    db = event.target.result;
    render();
    loadMasterData(); // DBæº–å‚™å®Œäº†å¾Œã«ãƒã‚¹ã‚¿ãƒ¼èª­ã¿è¾¼ã¿
  };

  // 1. ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«å…¥ã‚Œã‚‹
  function loadMasterData() {
    // â˜…ã“ã“ã‚’è‡ªåˆ†ã®GitHub URLã«æ›¸ãæ›ãˆã¦ãã ã•ã„ï¼
    const masterUrl = "https://thumpman-graffitti.github.io/pwa-test/live_master.json";

    fetch(masterUrl)
      .then(res => res.json())
      .then(data => {
        const select = document.getElementById("masterSelect");
        select.innerHTML = '<option value="">ãƒ©ã‚¤ãƒ–ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
        data.forEach(live => {
          const option = document.createElement("option");
          option.value = JSON.stringify(live);
          option.textContent = `${live.date} - ${live.tour}`;
          select.appendChild(option);
        });
      })
      .catch(err => {
        console.error(err);
        document.getElementById("masterSelect").innerHTML = '<option value="">ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—</option>';
      });
  }

  // 2. ä¿å­˜å‡¦ç†ï¼ˆ1ã¤ã«çµ±åˆï¼‰
  function saveLive() {
    const selectedValue = document.getElementById("masterSelect").value;
    const memo = document.getElementById("memo").value;

    if (!selectedValue) {
      alert("ãƒ©ã‚¤ãƒ–ã‚’é¸æŠã—ã¦ãã ã•ã„");
      return;
    }

    const liveData = JSON.parse(selectedValue);
    const tx = db.transaction("lives", "readwrite");
    const store = tx.objectStore("lives");

    store.add({ 
      date: liveData.date, 
      venue: liveData.venue,
      tour: liveData.tour,
      memo: memo 
    });

    tx.oncomplete = () => {
      document.getElementById("memo").value = "";
      render();
    };
  }

  // 3. è¡¨ç¤ºå‡¦ç†
  function render() {
    const list = document.getElementById("list");
    list.innerHTML = "";

    const tx = db.transaction("lives", "readonly");
    const store = tx.objectStore("lives");

    store.openCursor().onsuccess = (event) => {
      const cursor = event.target.result;
      if (cursor) {
        const li = document.createElement("li");
        const d = cursor.value;
        
        // è¡¨ç¤ºå†…å®¹ã‚’ãƒªãƒƒãƒã«
        li.innerHTML = `
          <strong>${d.date} ${d.tour}</strong><br>
          <small>ä¼šå ´: ${d.venue} ${d.memo ? ' / ãƒ¡ãƒ¢: ' + d.memo : ''}</small>
        `;

        const delBtn = document.createElement("button");
        delBtn.textContent = "å‰Šé™¤";
        delBtn.className = "delete-btn";
        const currentId = cursor.primaryKey;
        delBtn.onclick = () => deleteLive(currentId);

        li.appendChild(delBtn);
        list.appendChild(li);
        cursor.continue();
      }
    };
  }

  // å‰Šé™¤å‡¦ç†
  function deleteLive(id) {
    if (!confirm("ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    const tx = db.transaction("lives", "readwrite");
    tx.objectStore("lives").delete(id);
    tx.oncomplete = () => render();
  }

  // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆBOMä»˜ãUTF-8ï¼‰
  function exportData() {
    const tx = db.transaction("lives", "readonly");
    tx.objectStore("lives").getAll().onsuccess = (e) => {
      const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
      const blob = new Blob([bom, JSON.stringify(e.target.result, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "pg_live_log.json";
      a.click();
    };
  }

  // ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
  function importData() {
    const file = document.getElementById("importFile").files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      const json = JSON.parse(e.target.result);
      const tx = db.transaction("lives", "readwrite");
      const store = tx.objectStore("lives");
      json.forEach(item => { delete item.id; store.add(item); });
      tx.oncomplete = () => { alert("å¾©å…ƒå®Œäº†"); render(); };
    };
    reader.readAsText(file);
  }

  // å…¨å‰Šé™¤
  function testClear() {
    if (!confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    const tx = db.transaction("lives", "readwrite");
    tx.objectStore("lives").clear();
    tx.oncomplete = () => render();
  }
</script>

</body>
</html>
